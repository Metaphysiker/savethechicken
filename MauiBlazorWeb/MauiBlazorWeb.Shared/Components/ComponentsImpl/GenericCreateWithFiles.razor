@using MauiBlazorWeb.Shared.Factories.FactoriesImpl
@using MauiBlazorWeb.Shared.Resources.Strings
@using MauiBlazorWeb.Shared.Services.ServicesImpl
@using MauiBlazorWeb.Web.Services.ServicesImpl
@inject AwsFileService AwsFileService
@using Microsoft.Extensions.Localization
@using global::Shared.Dtos.DtosImpl
@inject IJSRuntime JS
@typeparam TDto where TDto : class, IEntityWithFileDtos
@inject GenericDtoServiceFactory DtoServiceFactory
@inject IStringLocalizer<AppResources> L
@inject NavigationManager NavigationManager

@if(model != null){
    <EditForm Model="model" OnValidSubmit="HandleValidSubmit">
        <ObjectGraphDataAnnotationsValidator />

        @ChildContent(model)

        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">
            @L["Create"]
        </MudButton>
    </EditForm>
}

@code {
    [Parameter, EditorRequired] public ItemWithBrowserFiles<TDto> model { get; set; } = default!;

    [Parameter, EditorRequired] public RenderFragment<ItemWithBrowserFiles<TDto>> ChildContent { get; set; } = default!;

    private GenericDtoService<TDto, ISearchDto>? _service;



    protected override void OnInitialized()
    {
        _service = DtoServiceFactory.Create<TDto, ISearchDto>();
        if (model == null)
        {
            model = Activator.CreateInstance<ItemWithBrowserFiles<TDto>>();
        }
        StateHasChanged();
    }

    private async Task HandleValidSubmit()
    {
        if (_service != null && model != null)
        {


            try
            {
                var storedFiles = await UploadFilesAsync(model);
                model.Item.Files.AddRange(storedFiles);
                await _service.CreateAsync(model.Item);
                NavigationManager.NavigateTo("/thank-you"); // Only runs if CreateAsync succeeds
            }
            catch (Exception ex)
            {
                // Optionally show an error message to the user
                // e.g., set an error flag or log the exception
            }
        }
    }

    private async Task<List<StoredFileDto>> UploadFilesAsync(ItemWithBrowserFiles<TDto> itemWithFiles)
    {
        List<StoredFileDto> storedFiles = new List<StoredFileDto>();
        foreach (var file in itemWithFiles.Files)
        {
            var key = await AwsFileService.UploadFileAsync(file);
            if(!string.IsNullOrEmpty(key))
            {
                StoredFileDto storedFile = new StoredFileDto
                {
                    FileName = file.Name,
                    FileKey = key,
                    ContentType = file.ContentType,
                };

                storedFiles.Add(storedFile);
            }
        }
        return storedFiles;
    }
}
