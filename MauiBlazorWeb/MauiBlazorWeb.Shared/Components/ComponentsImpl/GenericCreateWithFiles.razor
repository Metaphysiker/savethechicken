@using MauiBlazorWeb.Shared.Factories.FactoriesImpl
@using MauiBlazorWeb.Web.Services.ServicesImpl
@using global::Shared.Dtos.DtosImpl
@inject IJSRuntime JS
@typeparam TDto where TDto : class, IEntityWithFiles
@inject GenericDtoServiceFactory DtoServiceFactory

@if(itemWithFiles != null && model != null){
    <EditForm Model="model" OnValidSubmit="HandleValidSubmit">
        <ObjectGraphDataAnnotationsValidator />

        @ChildContent(itemWithFiles)

        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">
            Create
        </MudButton>
    </EditForm>
}

@code {
    [Parameter] public TDto model { get; set; } = default!;

    ItemWithBrowserFiles<TDto>? itemWithFiles = null;

    [Parameter] public RenderFragment<ItemWithBrowserFiles<TDto>> ChildContent { get; set; } = default!;

    private GenericDtoService<TDto, ISearchDto>? _service;



    protected override void OnInitialized()
    {
        _service = DtoServiceFactory.Create<TDto, ISearchDto>();
        if (model == null)
        {
            model = Activator.CreateInstance<TDto>();
        }
        itemWithFiles = new ItemWithBrowserFiles<TDto>();
        itemWithFiles.Item = model;
    }

    private async Task HandleValidSubmit()
    {
        if (_service != null && itemWithFiles != null)
        {
            // console log the files
            foreach (var file in itemWithFiles.Files)
            {
                //javascript console log
                await JS.InvokeVoidAsync("console.log", $"File: {file.Name}, Size: {file.Size} bytes");

               // Console.WriteLine($"File: {file.Name}, Size: {file.Size} bytes");
            }

            //await _service.CreateAsync(model);
        }
    }
}
